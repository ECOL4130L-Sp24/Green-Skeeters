---
title: "Deliverable 3 Data Analyses"
output: html_document
date: "2024-03-14"
authors: Anderson,Cabe,Gabby
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

## ANOVA and graphs comparing season and mosquito pathogen positivity across sites

```{r, message = FALSE}
# Loading appropriate packages

library(tidyverse)
library(here)
library(cowplot)
library(viridis)
```

```{r}
# Read in data
temp_day <- read_csv(here("data", "processed", "temp_day.csv"))
mosquito_clean <- read_csv(here("data", "processed", "mosquito_clean.csv"))
```

```{r}
#Convert mosquito test data into binary values
mosquito_binary <- mosquito_clean %>% 
  mutate(testResult_mos= ifelse(testResult=="Positive",1,0),
         collectDate = floor_date(endCollectDate, "day")) %>% 
  dplyr::select(-startCollectDate, -endCollectDate)
```

```{r}
#Joining data sheets, making a new season column and dropping unneeded variables
mosquito_day <- mosquito_clean %>% 
  dplyr::select(-startCollectDate) %>% 
  mutate(collectDate = as_date(endCollectDate)) %>% 
  dplyr::select(-endCollectDate) 

temp_day_join <- temp_day %>% 
  mutate(collectDate = as_date(collectDate))

temp_mos_raw <-
  inner_join(mosquito_binary, temp_day_join) %>% 
  dplyr::select(-testResult)

temp_mos_season <- temp_mos_raw %>% 
  mutate(month = month(collectDate),
         season = ifelse(month %in% c(06,07,08), "summer",
                         ifelse(month %in% c(09,10,11), "fall",
                                ifelse(month %in% c(12,01,02), "winter",
                                        ifelse(month %in% c(03,04,05), "spring",
                                                "NA"))))) %>% 
  dplyr::group_by(siteID, season, testResult_mos) %>%
  summarize(mean_temp = mean(avg_temp, na.rm = TRUE), total = n()) %>% 
  arrange(-testResult_mos, total)

temp_mos_season

```
**KF comment: the model below is not currently using an appropriate response variable since "testResult_mos" represents the positive/negative groups, not values**
```{r}
#Poisson regression for "total" vs site * season
library(MASS)
#Loading package here because it is naughty
poisson1 <- glm(total ~ siteID * season, 
            data = temp_mos_season,
            family = poisson)

summary(poisson1)

plot(poisson1, which = 1)
poisson1$deviance / poisson1$df.residual

#Poisson GLM is overdispersed, default to negative binomial
siteID_season_nb <- glm.nb(total ~ siteID * season, 
               data = temp_mos_season)

summary(siteID_season_nb)

plot(siteID_season_nb, which = 1)
siteID_season_nb$deviance / siteID_season_nb$df.residual
```
#Negative binomial is way overdispersed -- do we roll with it?

```{r}
#Graph of proportion of positive results over seasons across sites
temp_mos_season_prop <- temp_mos_season %>% 
  pivot_wider(names_from = testResult_mos,
              values_from = total,
              values_fill = 0) %>% 
  mutate(prop_pos = `1` / sum(`0` + `1`)) %>% 
  mutate(season = factor(season,levels = c("fall", "winter", "spring", "summer")))

ggplot(data = temp_mos_season_prop, 
         aes(x = season, 
             y = prop_pos,
             col = siteID)) +
    geom_jitter(cex = 3,
                height = 0,
                width = 0.1) +
  labs( x = "Season", y = "Proportion positive test results") +
  theme_bw()
  
```

**KF note: remember that in .Rmd you can write in plain-text between code chunks! Using a single # will set a line as a "top level" header in your knit document. And the .Rmd visible width auto-adjusts and auto-wraps base on your computer screen so you also don't have to worry about enforcing specific line breaks! :) **

#Proportion of viral disease presence in mosquitoes separated by season of the year and NEON site from which data was gathered (DSNY = Disney World, Orlando, Florida; HARV = Cambridge, MA; MOAB = Moab, Utah; WOOD = Woods Hole, Massachussetts. The only positive test results occurred in summer, with Moab, Ut, having the highest proportion of positives.
```{r}
#Running a linear model on temperature and proportion of positive results 
prop_positive_lm <- lm(prop_pos ~ mean_temp, data = temp_mos_season_prop)
summary(prop_positive_lm)

par(mfrow = c(1, 3))

plot(prop_positive_lm, which = 1:3)
#Fits assumptions-ish

summary(prop_positive_lm)
#insignificant
```

```{r}
#Graph of linear model
ggplot(data = temp_mos_season_prop, 
         aes(x = mean_temp, 
             y = prop_pos,
             fill = siteID)) +
    geom_point(cex = 5, pch = 21) +
  labs(x = "Mean temperature (C)", y = "Proportion positive test results") +
  theme_bw() +
  guides(fill = guide_legend(title = "Site"))
```

```{r}
#Graph of proportion of positive results of virus types across sites 
temp_mos_pathogen <- temp_mos_raw %>% 
  drop_na() %>% 
  group_by(siteID, testResult_mos, testPathogenName) %>% 
  summarize(total = n()) %>% 
  pivot_wider(names_from = testResult_mos,
              values_from = total,
              values_fill = 0) %>% 
  mutate(prop_pos = `1` / sum(`0` + `1`)) %>% 
  filter(prop_pos > 0)

ggplot(data = temp_mos_pathogen, 
         aes(x = siteID, 
             y = prop_pos,
             fill = testPathogenName)) +
    geom_jitter(cex = 5, pch = 21,
                height = 0,
                width = 0.1) +
  labs( x = "Site", y = "Proportion positive test results", color = "Virus") +
  theme_bw() +
  guides(fill = guide_legend(title = "Virus"))

```
Proportion of positive test results separated by site ID and pathogen. The pathogens detected were Flavivirus, West Nile, 	Orthobunyavirus sp., and California encephalitis virus. The prevalence of both Flavirus and West Nile virus was higher in Woods Hole than Disney. Moab had no Flavivirus or West Nile virus, but had the highest proportion of positive results. The positive results came from California encephalitis virus and Orthobunyavirus sp.

#Making a graph showing mean temperature against proportionon of positive results. 
```{r}
ggplot(data = temp_mos_season_prop, 
         aes(x = mean_temp, 
             y = prop_pos,
             col = siteID)) +
    geom_jitter(cex = 3,
                height = 0,
                width = 0.1) +
  labs( x = "Mean temperature of season (Â°C)", y = "Proportion of positive test results") +
  theme_bw()
```


#Using a linear regression to evaluate the relationship between proportion postive results and mean temperature. 
```{r}
cor_value <- cor(x = temp_mos_season_prop$mean_temp, 
                 y = temp_mos_season_prop$prop_pos)
print(cor_value)
model1 <- lm(prop_pos ~ mean_temp, data = temp_mos_season_prop)
summary(model1)
cor_value^2
```
#The relationship came back not significant (F(1,13)=.042, p=.84)

```{r}
# Count of positive and negative results for each temperature category
testResult_temp_sum <- temp_mos_season %>%
  group_by(siteID, season) %>% 
  pivot_wider(names_from= testResult_mos, values_from = total) %>% 
  summarise(
    positive_count = sum(testResult_mos, total),
    negative_count = sum(1 - testResult_mos, total))

# Create a bar plot to visualize the counts of positive and negative results for each temperature category
ggplot(testResult_temp_sum, aes(x = mean_temp)) +
  geom_bar(aes(y = positive_count), stat = "identity", fill = "blue", alpha = 0.5) +
  geom_bar(aes(y = negative_count), stat = "identity", fill = "red", alpha = 0.5) +
  labs(x = "Mean Temperature", y = "Count of Test Results", title = "Count of Test Results by Mean Temperature") +
  scale_fill_manual(values = c("blue", "red"), name = "Test Result",
                    labels = c("Positive", "Negative")) +
  theme_minimal() +
  scale_x_continuous(breaks = seq(min(testResult_temp_sum$mean_temp), max(testResult_temp_sum$mean_temp), by = 5))  
```

