---
title: "Deliverable 3 Data Analyses"
output: html_document
date: "2024-03-14"
authors: Anderson,Cabe,Gabby
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

## ANOVA and graphs comparing season and mosquito pathogen positivity across sites

```{r, message = FALSE}
# Loading appropriate packages

library(tidyverse)
library(here)
library(cowplot)
library(viridis)
library(MASS)
```

```{r}
# Read in data
temp_day <- read_csv(here("data", "processed", "temp_day.csv"))
mosquito_clean <- read_csv(here("data", "processed", "mosquito_clean.csv"))
```

```{r}
#Convert mosquito test data into binary values
mosquito_binary <- mosquito_clean %>% 
  mutate(testResult_mos= ifelse(testResult=="Positive",1,0),
         collectDate = floor_date(endCollectDate, "day")) %>% 
  select(-startCollectDate, -endCollectDate)
```

```{r}
#Joining data sheets, making a new season column and dropping unneeded variables
mosquito_day <- mosquito_clean %>% 
  select(-startCollectDate) %>% 
  mutate(collectDate = as_date(endCollectDate)) %>% 
  select(-endCollectDate) 

temp_day_join <- temp_day %>% 
  mutate(collectDate = as_date(collectDate))

temp_mos_raw <-
  inner_join(mosquito_binary, temp_day_join) %>% 
  select(-testResult)

temp_mos_season <- temp_mos_raw %>% 
  mutate(month = month(collectDate),
         season = ifelse(month %in% c(06,07,08), "summer",
                         ifelse(month %in% c(09,10,11), "fall",
                                ifelse(month %in% c(12,01,02), "winter",
                                        ifelse(month %in% c(03,04,05), "spring",
                                                "NA"))))) %>% 
  group_by(siteID, season, testResult_mos) %>% 
  summarize(total = n()) %>% 
  arrange(-testResult_mos, total)

temp_mos_season

```
**KF comment: the model below is not currently using an appropriate response variable since "testResult_mos" represents the positive/negative groups, not values**
```{r}
#Poisson regression for "total" vs site * season
poisson1 <- glm(total ~ siteID * season, 
            data = temp_mos_season,
            family = poisson)

summary(poisson1)

plot(poisson1, which = 1)
poisson1$deviance / poisson1$df.residual

#Poisson GLM is overdispersed, default to negative binomial
siteID_season_nb <- glm.nb(total ~ siteID * season, 
               data = temp_mos_season)

summary(siteID_season_nb)

plot(siteID_season_nb, which = 1)
siteID_season_nb$deviance / siteID_season_nb$df.residual
```

```{r}
#Graph of proportion of positive results over seasons across sites
temp_mos_season_prop <- temp_mos_season %>% 
  pivot_wider(names_from = testResult_mos,
              values_from = total,
              values_fill = 0) %>% 
  mutate(prop_pos = `1` / sum(`0` + `1`)) %>% 
  mutate(season = factor(season,levels = c("fall", "winter", "spring", "summer")))

ggplot(data = temp_mos_season_prop, 
         aes(x = season, 
             y = prop_pos,
             col = siteID)) +
    geom_jitter(cex = 3,
                height = 0,
                width = 0.1) +
  labs( x = "Season", y = "Proportion of positive test results") +
  theme_bw()
  
```

**KF note: remember that in .Rmd you can write in plain-text between code chunks! Using a single # will set a line as a "top level" header in your knit document. And the .Rmd visible width auto-adjusts and auto-wraps base on your computer screen so you also don't have to worry about enforcing specific line breaks! :) **

Proportion of viral disease presence in mosquitoes separated by season of the year and NEON site from which data was gathered (DSNY = Disney World, Orlando, Florida; HARV = Cambridge, MA; MOAB = Moab, Utah; WOOD = Woods Hole, Massachussetts. The only positive test results occurred in summer, with Woods Hole, MA, having the highest proportion of positives.

```{r}
#Graph of proportion of positive results of virus types across sites 
temp_mos_pathogen <- temp_mos_raw %>% 
  drop_na() %>% 
  group_by(siteID, testResult_mos, testPathogenName) %>% 
  summarize(total = n()) %>% 
  pivot_wider(names_from = testResult_mos,
              values_from = total,
              values_fill = 0) %>% 
  mutate(prop_pos = `1` / sum(`0` + `1`))

ggplot(data = temp_mos_pathogen, 
         aes(x = siteID, 
             y = prop_pos,
             col = testPathogenName)) +
    geom_jitter(cex = 3,
                height = 0,
                width = 0.1) +
  labs( x = "Site", y = "Proportion of positive test results", color = "Virus") +
  theme_bw()

```
Proportion of positive test results separated by site ID and pathogen. The only pathogens detected were *Flavivirus* and West Nile, and the prevalence of both viruses was higher in Woods Hole than Disney.
